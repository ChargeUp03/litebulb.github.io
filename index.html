<!DOCTYPE html>
<html>
<head>
    <title>Litebulb</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="text/plain" href="favicon.ico"> 
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="manifest" href="site.webmanifest">
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background: #fff; color: #000; }
        .dark { background: #121212; color: #eee; }
        
        /* Header */
        #head { position: fixed; top: 0; width: 100%; background: #eee; border-bottom: 1px solid #ccc; padding: 5px; font-size: 12px; z-index: 10; }
        .dark #head { background: #222; border-color: #444; }

        /* Chat Area */
        #history { padding: 45px 10px 80px 10px; font-size: 14px; line-height: 1.4; }
        .msg { margin-bottom: 15px; padding: 8px; border-radius: 5px; }
        .user { background: #e3f2fd; border-left: 4px solid #2196f3; }
        .ai { background: #f5f5f5; border-left: 4px solid #4caf50; }
        .dark .user { background: #1a237e; border-color: #3f51b5; }
        .dark .ai { background: #1b5e20; border-color: #4caf50; }

        /* Bottom Bar */
        #bottom { position: fixed; bottom: 0; width: 100%; background: #fff; border-top: 1px solid #ccc; padding: 10px; z-index: 10; }
        .dark #bottom { background: #121212; border-color: #444; }
        #p { width: 60%; font-size: 16px; }
    </style>
</head>
<body id="b" class="light">

<div id="head">
    <b>Litebulb</b> | Gemini 3 Flash | 
    <input type="checkbox" onclick="document.getElementById('b').className=(this.checked?'dark':'light')"> Dark
</div>

<div id="history">
    <div class="msg ai">Welcome to Litebulb. How can I help?</div>
</div>

<div id="bottom">
    <input type="file" id="img" accept="image/*" style="display:none" onchange="imgTag()">
    <button onclick="document.getElementById('img').click()">Img</button>
    <input type="text" id="p" placeholder="Type here...">
    <button onclick="ask()">Send</button>
    <div id="status" style="font-size:10px; color:gray;"></div>
</div>

<script>
    var currentImg = null;

    function imgTag() {
        var file = document.getElementById('img').files[0];
        var reader = new FileReader();
        reader.onloadend = function() { 
            currentImg = reader.result; 
            document.getElementById('status').innerText = "Image attached."; 
        }
        if(file) reader.readAsDataURL(file);
    }

    function ask() {
        var p = document.getElementById('p');
        var hist = document.getElementById('history');
        var val = p.value;
        if(!val && !currentImg) return;

        // Add user message to screen
        hist.innerHTML += '<div class="msg user">' + (currentImg ? '<b>[Image Attached]</b><br>' : '') + val + '</div>';
        p.value = "";
        window.scrollTo(0, document.body.scrollHeight);

        var xhr = new XMLHttpRequest();
        
        // --- CACHE BUSTER FOR IPOD/IOS 6 ---
        var scriptUrl = "https://script.google.com/macros/s/AKfycbyutfg_ejiM08iqAXWkhHE2W43TZq0OMuPVUmaOEB1uPQfJvV5NpHoEFg-oWNNgBi4p/exec"; 
        var cacheBuster = "?t=" + new Date().getTime();
        
        xhr.open("POST", scriptUrl + cacheBuster, true);

        // Standard headers
        xhr.setRequestHeader("Content-Type", "text/plain");
        xhr.setRequestHeader("Cache-Control", "no-cache");

        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4) {
                // If it worked, add AI response to chat
                hist.innerHTML += '<div class="msg ai">' + xhr.responseText + '</div>';
                document.getElementById('status').innerText = "";
                currentImg = null;
                window.scrollTo(0, document.body.scrollHeight);
            }
        };

        document.getElementById('status').innerText = "Thinking...";
        
        // Wrap data in JSON string
        var data = JSON.stringify({prompt: val, image: currentImg});
        xhr.send(data);
    }
</script>

</body>
</html>
